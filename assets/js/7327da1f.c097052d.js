"use strict";(self.webpackChunkcodecookbook=self.webpackChunkcodecookbook||[]).push([[569],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),u=d(n),m=r,h=u["".concat(l,".").concat(m)]||u[m]||c[m]||o;return n?a.createElement(h,s(s({ref:t},p),{},{components:n})):a.createElement(h,s({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[u]="string"==typeof e?e:r,s[1]=i;for(var d=2;d<o;d++)s[d]=n[d];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},4523:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>d,toc:()=>u});var a=n(7462),r=n(7294),o=n(3905);const s=e=>{let{slug:t}=e;return r.createElement("div",null,r.createElement("div",{className:"gumroad-product-embed"},r.createElement("a",{href:`https://8520699716163.gumroad.com/l/${t}`},"Loading...")))},i={sidebar_position:1},l="Username & Password",d={unversionedId:"users-auth/username-password",id:"users-auth/username-password",title:"Username & Password",description:"This recipe will show you how to register users, save hashed and salted passwords in a database and issue JWTs that the frontend can use for subsequent requests.",source:"@site/recipes/users-auth/username-password.mdx",sourceDirName:"users-auth",slug:"/users-auth/username-password",permalink:"/recipes/users-auth/username-password",draft:!1,editUrl:"https://github.com/code-cookbook/code-cookbook.github.io/tree/main/recipes/users-auth/username-password.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"recipeSidebar",previous:{title:"Users & Auth",permalink:"/recipes/category/users--auth"},next:{title:"Social Authentication",permalink:"/recipes/users-auth/social"}},p={},u=[{value:"Ingredients",id:"ingredients",level:2},{value:"Outputs",id:"outputs",level:2},{value:"Screens",id:"screens",level:3},{value:"Endpoints",id:"endpoints",level:3},{value:"Tables",id:"tables",level:3},{value:"Method",id:"method",level:2},{value:"Registration endpoint",id:"registration-endpoint",level:3},{value:"Request Body",id:"request-body",level:4},{value:"Logic",id:"logic",level:4},{value:"Response Body",id:"response-body",level:4},{value:"Login Endpoint",id:"login-endpoint",level:3},{value:"Request Body",id:"request-body-1",level:4},{value:"Logic",id:"logic-1",level:4},{value:"Response Body",id:"response-body-1",level:4},{value:"Protected Endpoints",id:"protected-endpoints",level:3},{value:"Request Headers",id:"request-headers",level:4},{value:"Logic",id:"logic-2",level:4},{value:"Ready-Made Code",id:"ready-made-code",level:2}],c={toc:u},m="wrapper";function h(e){let{components:t,...n}=e;return(0,o.kt)(m,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"username--password"},"Username & Password"),(0,o.kt)("p",null,"This recipe will show you how to register users, save hashed and salted passwords in a database and issue JWTs that the frontend can use for subsequent requests."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Looking for complete code samples? Check the ",(0,o.kt)("a",{parentName:"p",href:"#ready-made-code"},"ready made code")," section!")),(0,o.kt)("h2",{id:"ingredients"},"Ingredients"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Crypto library for hashing passwords"),(0,o.kt)("li",{parentName:"ol"},"JWT library for generating JSON web tokens")),(0,o.kt)("h2",{id:"outputs"},"Outputs"),(0,o.kt)("h3",{id:"screens"},"Screens"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Name"),(0,o.kt)("th",{parentName:"tr",align:null},"Path"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Register"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"/register")),(0,o.kt)("td",{parentName:"tr",align:null},"Displays the registration form and sends data to the ",(0,o.kt)("inlineCode",{parentName:"td"},"POST /users")," endpoint")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Login"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"/login")),(0,o.kt)("td",{parentName:"tr",align:null},"Displays the login form and sends data to the ",(0,o.kt)("inlineCode",{parentName:"td"},"POST /auth/login")," endpoint")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Dashboard"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"/")),(0,o.kt)("td",{parentName:"tr",align:null},"Only accessible if the user has a valid JWT issued. Fetches data from ",(0,o.kt)("inlineCode",{parentName:"td"},"GET /me"))))),(0,o.kt)("h3",{id:"endpoints"},"Endpoints"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Method"),(0,o.kt)("th",{parentName:"tr",align:null},"Path"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"POST"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"/users")),(0,o.kt)("td",{parentName:"tr",align:null},"Register a new user")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"POST"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"/auth/login")),(0,o.kt)("td",{parentName:"tr",align:null},"Validates the email/password and returns a JWT")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"GET"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"/me")),(0,o.kt)("td",{parentName:"tr",align:null},"Returns the current user's details, only if logged in")))),(0,o.kt)("h3",{id:"tables"},"Tables"),(0,o.kt)("mermaid",{value:"erDiagram\n  User {\n      int id PK\n      string email\n      string firstName\n      string lastName\n      string password\n      string createdAt\n      string updatedAt\n  }\n"}),(0,o.kt)("h2",{id:"method"},"Method"),(0,o.kt)("h3",{id:"registration-endpoint"},"Registration endpoint"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"POST /users")," endpoint is where user accounts will be registered. It accepts a body that should contain all user information necessary to create an account, including the email and password."),(0,o.kt)("h4",{id:"request-body"},"Request Body"),(0,o.kt)("p",null,"The request body can contain as few or as many fields as required for your use case. You may wish to omit the first and last names, for example."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "firstName": "Fred",\n  "lastName": "Smith",\n  "email": "fred@codecookbook.io",\n  "password": "MyS3cureP@assword#"\n}\n')),(0,o.kt)("h4",{id:"logic"},"Logic"),(0,o.kt)("mermaid",{value:'%%{init: { "sequence": { "mirrorActors":false }}}%%\nsequenceDiagram\n    Browser->>+API: Register\n    API->>+Database: User exists?\n    opt\n      Database--\x3e>API: True\n      API--\x3e>Browser: 400 Bad Request\n    end\n    Database--\x3e>-API: False\n    API->>+Crypto: Hash password\n    Crypto--\x3e>-API: Result\n\n    API->>+Database: Create user\n    Note right of Database: Hashed password saved to database\n    Database--\x3e>-API: User\n    API--\x3e>-Browser: 201 Created'}),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Ensure all provided fields are valid (including password requirements)"),(0,o.kt)("li",{parentName:"ol"},"Hash and salt the provided password"),(0,o.kt)("li",{parentName:"ol"},"Save the information to the User database table"),(0,o.kt)("li",{parentName:"ol"},"Return the newly created user information")),(0,o.kt)("h4",{id:"response-body"},"Response Body"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "id": 1234,\n  "firstName": "Fred",\n  "lastName": "Smith",\n  "email": "fred@codecookbook.io",\n  "createdAt": "2023-04-12T20:07:22.115Z",\n  "updatedAt": "2023-04-12T20:07:22.115Z"\n}\n')),(0,o.kt)("h3",{id:"login-endpoint"},"Login Endpoint"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"POST /auth/login")," endpoint accepts the user's credentials and returns a JSON web token (JWT) which should be stored by the client for subsequent requests."),(0,o.kt)("h4",{id:"request-body-1"},"Request Body"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "email": "fred@codecookbook.io",\n  "password": "MyS3cureP@assword#"\n}\n')),(0,o.kt)("h4",{id:"logic-1"},"Logic"),(0,o.kt)("mermaid",{value:'%%{init: { "sequence": { "mirrorActors":false }}}%%\nsequenceDiagram\n    participant Browser\n    participant API\n    participant Database\n    participant Crypto\n    participant JWT\n    Browser->>+API: Credentials\n    API->>+Database: User exists?\n    opt\n      Database--\x3e>API: False\n      API--\x3e>Browser: 401 Unauthorized\n    end\n    Database--\x3e>-API: User\n    API->>+Crypto: Passwords match?\n    Crypto--\x3e>-API: True\n    API->>+JWT: Sign token\n    Note left of JWT: User ID and email in payload\n    JWT--\x3e>-API: Token\n    API--\x3e>-Browser: Token (201 Created)\n    Note right of Browser: Browser stores token in cookie'}),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Look up the user in the database based on the ",(0,o.kt)("inlineCode",{parentName:"li"},"email")," field",(0,o.kt)("br",{parentName:"li"}),"a. Check the user exists",(0,o.kt)("br",{parentName:"li"}),"b. Use the bcrypt library to compare the provided password to the hashed password saved in the database"),(0,o.kt)("li",{parentName:"ol"},"Generate a JWT, providing the user's ID as the ",(0,o.kt)("inlineCode",{parentName:"li"},"sub")," field"),(0,o.kt)("li",{parentName:"ol"},"Return the JWT to the client along with the user's information")),(0,o.kt)("h4",{id:"response-body-1"},"Response Body"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",\n  "user": {\n    {\n      "id": 1234,\n      "firstName": "Fred",\n      "lastName": "Smith",\n      "email": "fred@codecookbook.io",\n      "createdAt": "2023-04-12T20:07:22.115Z",\n      "updatedAt": "2023-04-12T20:07:22.115Z"\n    }\n  }\n}\n')),(0,o.kt)("h3",{id:"protected-endpoints"},"Protected Endpoints"),(0,o.kt)("p",null,"In this example we will create an endpoint called ",(0,o.kt)("inlineCode",{parentName:"p"},"GET /users/:id")," which will return the specified user's details, but only if a valid JWT is provided and the ",(0,o.kt)("inlineCode",{parentName:"p"},"sub")," field matches the user ID requested. In other words, a user shouldn't be able to view another user's details."),(0,o.kt)("h4",{id:"request-headers"},"Request Headers"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\n")),(0,o.kt)("h4",{id:"logic-2"},"Logic"),(0,o.kt)("mermaid",{value:'%%{init: { "sequence": { "mirrorActors":false }}}%%\nsequenceDiagram\n    participant Browser\n    participant API\n    participant Database\n    participant JWT\n    Browser->>+API: Request\n    Note right of Browser: JWT in Authorization header\n    opt No JWT\n      API--\x3e>Browser: 401 Unauthorized\n    end\n    API->>+JWT: Verify token\n    opt\n      JWT--\x3e>API: False\n      API--\x3e>Browser: 401 Unauthorized\n    end\n    JWT--\x3e>-API: User\n    API->>+Database: Get User by ID\n    Note right of API: Find user by ID from token\n    Database--\x3e>-API: User\n    API->>API: Action permitted?\n    Note right of API: Implement roles & permissions here\n    API--\x3e>-Browser: 200 OK\n'}),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Verify the ",(0,o.kt)("inlineCode",{parentName:"li"},"Authorization")," header has been provided"),(0,o.kt)("li",{parentName:"ol"},"Use the JWT library to validate the provided token"),(0,o.kt)("li",{parentName:"ol"},"Get the user based on the ",(0,o.kt)("inlineCode",{parentName:"li"},"sub")," property extracted from the token (the user ID)"),(0,o.kt)("li",{parentName:"ol"},"Throw an unauthorized exception if any of the above fails")),(0,o.kt)("h2",{id:"ready-made-code"},"Ready-Made Code"),(0,o.kt)("p",null,"Download this recipe as a complete application!"),(0,o.kt)(s,{slug:"username-password-auth-nest",mdxType:"GumroadEmbed"}))}h.isMDXComponent=!0}}]);